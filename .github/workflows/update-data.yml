name: Update Debate Data

on:
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Check current data size
      id: current-size
      run: |
        if [ -f "src/data.json" ]; then
          CURRENT_SIZE=$(jq length src/data.json)
          echo "current_size=$CURRENT_SIZE" >> $GITHUB_OUTPUT
        else
          echo "current_size=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Scrape new data
      run: |
        cd src
        node scrape_all_schools_to_json.js
      env:
        OPENCASELIST_USERNAME: ${{ secrets.OPENCASELIST_USERNAME }}
        OPENCASELIST_PASSWORD: ${{ secrets.OPENCASELIST_PASSWORD }}
    
    - name: Check new data size
      id: new-size
      run: |
        NEW_SIZE=$(jq length src/data.json)
        echo "new_size=$NEW_SIZE" >> $GITHUB_OUTPUT
    
    - name: Compare and update data
      run: |
        CURRENT_SIZE=${{ steps.current-size.outputs.current_size }}
        NEW_SIZE=${{ steps.new-size.outputs.new_size }}
        
        echo "Current size: $CURRENT_SIZE"
        echo "New size: $NEW_SIZE"
        
        if [ "$NEW_SIZE" -gt "$CURRENT_SIZE" ]; then
          echo "New data has more records ($NEW_SIZE vs $CURRENT_SIZE). Updating..."
          echo "DATA_UPDATED=true" >> $GITHUB_ENV
        else
          echo "New data has same or fewer records. Keeping existing data."
          git checkout src/data.json
          echo "DATA_UPDATED=false" >> $GITHUB_ENV
        fi
    
    - name: Commit and push if data updated
      if: env.DATA_UPDATED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add src/data.json
        git commit -m "Update debate data: ${{ steps.new-size.outputs.new_size }} records"
        git push